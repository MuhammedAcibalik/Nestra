// Nestra - Universal Cutting Optimization System
// Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CONFIGURATION TABLES ====================

model MeasurementUnit {
  id          String   @id @default(uuid())
  name        String   // e.g., "Millimeter", "Santimetre"
  symbol      String   // e.g., "mm", "cm", "m", "inch"
  type        String   // "length" | "area"
  conversionToBase Float // Conversion factor to base unit (mm for length, mm² for area)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([symbol, type])
}

model Currency {
  id          String   @id @default(uuid())
  name        String   // e.g., "Türk Lirası", "US Dollar"
  code        String   @unique // e.g., "TRY", "USD", "EUR"
  symbol      String   // e.g., "₺", "$", "€"
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Language {
  id          String   @id @default(uuid())
  name        String   // e.g., "Türkçe", "English"
  code        String   @unique // e.g., "tr", "en", "de"
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== MATERIAL & STOCK TABLES ====================

model MaterialType {
  id              String   @id @default(uuid())
  name            String   @unique // e.g., "SAC", "AHŞAP", "ALÜMİNYUM"
  description     String?
  isRotatable     Boolean  @default(true) // Can pieces be rotated (false for wood grain)
  defaultDensity  Float?   // kg/m³ for weight calculation
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  thicknessRanges ThicknessRange[]
  stockItems      StockItem[]
  machines        MachineCompatibility[]
}

model ThicknessRange {
  id              String   @id @default(uuid())
  materialTypeId  String
  materialType    MaterialType @relation(fields: [materialTypeId], references: [id], onDelete: Cascade)
  name            String   // e.g., "0.5-1.0mm", "1.0-2.0mm"
  minThickness    Float
  maxThickness    Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  stockItems      StockItem[]
  machines        MachineCompatibility[]

  @@unique([materialTypeId, name])
}

model StockItem {
  id              String   @id @default(uuid())
  code            String   @unique // User-defined stock code
  name            String
  materialTypeId  String
  materialType    MaterialType @relation(fields: [materialTypeId], references: [id])
  thicknessRangeId String?
  thicknessRange  ThicknessRange? @relation(fields: [thicknessRangeId], references: [id])
  thickness       Float    // Actual thickness value
  
  // Dimensions based on type
  stockType       StockType // "BAR_1D" | "SHEET_2D"
  
  // 1D dimensions (for bars, profiles, tubes)
  length          Float?   // For 1D items
  
  // 2D dimensions (for sheets, plates)
  width           Float?   // For 2D items
  height          Float?   // For 2D items
  
  // Inventory
  quantity        Int      @default(0) // Available quantity
  reservedQty     Int      @default(0) // Reserved for approved plans
  unitPrice       Float?   // Price per unit
  currencyId      String?
  
  // Location
  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id])
  
  // Flags
  isFromWaste     Boolean  @default(false) // Created from usable waste
  parentStockId   String?  // Original stock if from waste
  
  // Custom fields stored as JSON
  customFields    Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  stockMovements  StockMovement[]
  cuttingPlanItems CuttingPlanStock[]
}

enum StockType {
  BAR_1D
  SHEET_2D
}

// ==================== LOCATION & CUSTOMER TABLES ====================

model Location {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stockItems  StockItem[]
  machines    Machine[]
}

model Customer {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  email       String?
  phone       String?
  address     String?
  taxId       String?
  customFields Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders      Order[]
}

// ==================== MACHINE TABLES ====================

model Machine {
  id              String   @id @default(uuid())
  code            String   @unique
  name            String
  description     String?
  machineType     MachineType // "CNC_1D" | "CNC_2D" | "GUILLOTINE" | "LASER" | "PLASMA" etc.
  
  // Capabilities
  maxLength       Float?   // Max cutting length for 1D
  maxWidth        Float?   // Max sheet width for 2D
  maxHeight       Float?   // Max sheet height for 2D
  minCutLength    Float?   // Minimum cut size
  kerf            Float?   // Blade width / cutting kerf
  
  // Cutting type constraints
  onlyGuillotine  Boolean  @default(false) // Only straight cuts
  
  // Location
  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id])
  
  // Status
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  compatibilities MachineCompatibility[]
  cuttingPlans    CuttingPlan[]
}

enum MachineType {
  CNC_1D
  CNC_2D
  GUILLOTINE
  LASER
  PLASMA
  WATERJET
  SAW
  OTHER
}

model MachineCompatibility {
  id              String   @id @default(uuid())
  machineId       String
  machine         Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)
  materialTypeId  String
  materialType    MaterialType @relation(fields: [materialTypeId], references: [id], onDelete: Cascade)
  thicknessRangeId String?
  thicknessRange  ThicknessRange? @relation(fields: [thicknessRangeId], references: [id], onDelete: Cascade)
  
  // Optional speed/cost modifiers
  cuttingSpeed    Float?   // mm/min or m/min
  costPerUnit     Float?   // Cost per meter or per m²
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([machineId, materialTypeId, thicknessRangeId])
}

// ==================== USER & ROLE TABLES ====================

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String   // Hashed
  firstName   String
  lastName    String
  roleId      String
  role        Role     @relation(fields: [roleId], references: [id])
  isActive    Boolean  @default(true)
  languageId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders              Order[]
  optimizationScenarios OptimizationScenario[]
  approvedPlans       CuttingPlan[] @relation("ApprovedBy")
  productionLogs      ProductionLog[]
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // "admin" | "planner" | "operator" | "manager"
  displayName String   // "Sistem Yöneticisi", "Planlamacı", etc.
  permissions Json     // Array of permission strings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
}

// ==================== ORDER TABLES ====================

model Order {
  id              String   @id @default(uuid())
  orderNumber     String   @unique
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  createdById     String
  createdBy       User     @relation(fields: [createdById], references: [id])
  
  status          OrderStatus @default(DRAFT)
  priority        Int      @default(5) // 1-10, lower = higher priority
  dueDate         DateTime?
  notes           String?
  customFields    Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           OrderItem[]
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  IN_PLANNING
  IN_PRODUCTION
  COMPLETED
  CANCELLED
}

model OrderItem {
  id              String   @id @default(uuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Item identification
  itemCode        String?  // Part number / code
  itemName        String?
  
  // Geometry
  geometryType    GeometryType // "BAR_1D" | "RECTANGLE" | "CIRCLE" | "POLYGON" etc.
  
  // 1D dimensions
  length          Float?   // For 1D items
  
  // 2D dimensions
  width           Float?   // For rectangles
  height          Float?   // For rectangles
  diameter        Float?   // For circles
  polygonData     Json?    // For complex shapes: array of {x, y} points
  
  // Material requirements
  materialTypeId  String
  thickness       Float
  
  // Quantity
  quantity        Int
  producedQty     Int      @default(0)
  
  // Constraints
  canRotate       Boolean  @default(true)
  grainDirection  String?  // "horizontal" | "vertical" | null
  
  // Custom fields
  customFields    Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  cuttingJobItems CuttingJobItem[]
}

enum GeometryType {
  BAR_1D
  RECTANGLE
  CIRCLE
  SQUARE
  POLYGON
  FREEFORM
}

// ==================== CUTTING JOB TABLES ====================

model CuttingJob {
  id              String   @id @default(uuid())
  jobNumber       String   @unique
  
  // Grouping criteria
  materialTypeId  String
  thickness       Float
  
  status          CuttingJobStatus @default(PENDING)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           CuttingJobItem[]
  scenarios       OptimizationScenario[]
}

enum CuttingJobStatus {
  PENDING
  OPTIMIZING
  OPTIMIZED
  IN_PRODUCTION
  COMPLETED
}

model CuttingJobItem {
  id              String   @id @default(uuid())
  cuttingJobId    String
  cuttingJob      CuttingJob @relation(fields: [cuttingJobId], references: [id], onDelete: Cascade)
  orderItemId     String
  orderItem       OrderItem @relation(fields: [orderItemId], references: [id])
  
  // Quantity to produce in this job
  quantity        Int
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([cuttingJobId, orderItemId])
}

// ==================== OPTIMIZATION TABLES ====================

model OptimizationScenario {
  id              String   @id @default(uuid())
  name            String
  cuttingJobId    String
  cuttingJob      CuttingJob @relation(fields: [cuttingJobId], references: [id])
  createdById     String
  createdBy       User     @relation(fields: [createdById], references: [id])
  
  // Optimization parameters
  parameters      Json     // {objectives, weights, constraints}
  // See documentation for parameter structure
  
  // Stock selection
  useWarehouseStock Boolean @default(true)
  useStandardSizes  Boolean @default(true)
  selectedStockIds  Json?   // Array of specific stock UUIDs if manual selection
  
  status          ScenarioStatus @default(PENDING)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  results         CuttingPlan[]
}

enum ScenarioStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ==================== CUTTING PLAN TABLES ====================

model CuttingPlan {
  id              String   @id @default(uuid())
  planNumber      String   @unique
  scenarioId      String
  scenario        OptimizationScenario @relation(fields: [scenarioId], references: [id])
  
  // Results summary
  totalWaste      Float    // Total waste in units (mm or mm²)
  wastePercentage Float    // Waste percentage
  stockUsedCount  Int      // Number of stock items used
  estimatedTime   Float?   // Estimated production time in minutes
  estimatedCost   Float?   // Estimated cost
  
  // Status
  status          PlanStatus @default(DRAFT)
  approvedById    String?
  approvedBy      User?    @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  
  // Machine assignment
  machineId       String?
  machine         Machine? @relation(fields: [machineId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  stockItems      CuttingPlanStock[]
  productionLogs  ProductionLog[]
}

enum PlanStatus {
  DRAFT
  APPROVED
  IN_PRODUCTION
  COMPLETED
  CANCELLED
}

model CuttingPlanStock {
  id              String   @id @default(uuid())
  cuttingPlanId   String
  cuttingPlan     CuttingPlan @relation(fields: [cuttingPlanId], references: [id], onDelete: Cascade)
  stockItemId     String
  stockItem       StockItem @relation(fields: [stockItemId], references: [id])
  
  // Sequence order
  sequence        Int
  
  // Waste for this stock item
  waste           Float
  wastePercentage Float
  
  // Layout data in JSON format - structure depends on 1D vs 2D
  layoutData      Json
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([cuttingPlanId, sequence])
}

// ==================== PRODUCTION TABLES ====================

model ProductionLog {
  id              String   @id @default(uuid())
  cuttingPlanId   String
  cuttingPlan     CuttingPlan @relation(fields: [cuttingPlanId], references: [id])
  operatorId      String
  operator        User     @relation(fields: [operatorId], references: [id])
  
  // Actual vs Planned
  actualWaste     Float?
  actualTime      Float?   // Actual production time in minutes
  
  // Status
  status          ProductionStatus @default(STARTED)
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  
  notes           String?
  issues          Json?    // Array of issues/deviations
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  stockMovements  StockMovement[]
}

enum ProductionStatus {
  STARTED
  PAUSED
  COMPLETED
  CANCELLED
}

// ==================== STOCK MOVEMENT TABLES ====================

model StockMovement {
  id              String   @id @default(uuid())
  stockItemId     String
  stockItem       StockItem @relation(fields: [stockItemId], references: [id])
  
  movementType    MovementType
  quantity        Int
  
  // Reference
  productionLogId String?
  productionLog   ProductionLog? @relation(fields: [productionLogId], references: [id])
  
  notes           String?
  
  createdAt       DateTime @default(now())
}

enum MovementType {
  PURCHASE      // Stock purchase/entry
  CONSUMPTION   // Used in production
  WASTE_REUSE   // Created from usable waste
  SCRAP         // Scrapped/discarded
  ADJUSTMENT    // Manual adjustment
  TRANSFER      // Transfer between locations
}

// ==================== WASTE POLICY ====================

model WastePolicy {
  id              String   @id @default(uuid())
  name            String
  materialTypeId  String?  // null = applies to all materials
  
  // 1D thresholds (in mm)
  min1DUsableLength Float  @default(200)  // Below this = scrap
  
  // 2D thresholds (in mm²)
  min2DUsableArea   Float  @default(10000) // Below this = scrap
  min2DWidth        Float  @default(100)   // Minimum dimension
  min2DHeight       Float  @default(100)   // Minimum dimension
  
  isDefault       Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==================== CUSTOM FIELD DEFINITION ====================

model CustomFieldDefinition {
  id              String   @id @default(uuid())
  entityType      String   // "order" | "orderItem" | "stockItem" | "customer"
  fieldName       String
  displayName     String
  fieldType       String   // "text" | "number" | "date" | "select" | "boolean"
  options         Json?    // For select type: ["Option1", "Option2"]
  isRequired      Boolean  @default(false)
  defaultValue    String?
  sortOrder       Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([entityType, fieldName])
}

// ==================== LOCALIZATION ====================

model Translation {
  id          String   @id @default(uuid())
  languageCode String
  key         String   // e.g., "menu.orders", "label.save"
  value       String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([languageCode, key])
}
